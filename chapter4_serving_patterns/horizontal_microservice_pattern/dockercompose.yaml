version: "3"

services:
  proxy:
    container_name: proxy
    build:
      context: ..
      dockerfile: horizontal_microservice_pattern/Dockerfile.proxy
    environment:
      - PLATFORM=docker_compose
      - APP_NAME=src.api_composition_proxy.app.proxy:app
      - PORT=9000
      - SERVICE_SETOSA=service_setosa:8000
      - SERVICE_VERSICOLOR=service_versicolor:8001
      - SERVICE_VIRGINICA=service_virginica:8002
    ports:
      - "9000:9000"
    command: ./run.sh
    depends_on:
      - service_setosa
      - service_versicolor
      - service_virginica

  service_setosa:
    container_name: service_setosa
    build:
      context: ..
      dockerfile: horizontal_microservice_pattern/Dockerfile.service.setosa
    environment:
      - PLATFORM=docker_compose
      - PORT=8000
      - MODE=setosa
    ports:
      - "8000:8000"
    command: ./run.sh

  service_versicolor:
    container_name: service_versicolor
    build:
      context: ..
      dockerfile: horizontal_microservice_pattern/Dockerfile.service.versicolor
    environment:
      - PLATFORM=docker_compose
      - PORT=8001
      - MODE=versicolor
    ports:
      - "8001:8001"
    command: ./run.sh

  service_virginica:
    container_name: service_virginica
    build:
      context: ..
      dockerfile: horizontal_microservice_pattern/Dockerfile.service.virginica
    environment:
      - PLATFORM=docker_compose
      - PORT=8002
      - MODE=virginica
    ports:
      - "8002:8002"
    command: ./run.sh
